name: ðŸ”Ž Lean 4 Validation & Report

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate-lean:
    name: "ðŸ§  FormalizaciÃ³n Riemannâ€“Adelic (Lean 4.5.0)"
    runs-on: ubuntu-latest

    steps:
    # 1ï¸âƒ£  Clonar el repositorio
    - name: ðŸ”½ Checkout repository
      uses: actions/checkout@v4

    # 2ï¸âƒ£  Configurar Python (para el validador)
    - name: ðŸ Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    # 3ï¸âƒ£  Configurar Lean (via elan)
    - name: âš™ï¸ Install Lean 4.5.0 toolchain
      run: |
        curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y
        echo "$HOME/.elan/bin" >> $GITHUB_PATH
        elan toolchain install leanprover/lean4:v4.5.0
        elan default leanprover/lean4:v4.5.0
        lean --version

    # 4ï¸âƒ£  Ir al directorio de formalizaciÃ³n
    - name: ðŸ“‚ Navigate to Lean formalization folder
      working-directory: formalization/lean
      run: |
        echo "Contenido actual:"
        ls -la

    # 5ï¸âƒ£  Instalar dependencias del proyecto Lean
    - name: ðŸ“¦ Install Lean project dependencies
      working-directory: formalization/lean
      run: |
        lake update
        lake exe cache get || echo "Cache no disponible; continuarÃ¡ compilaciÃ³n completa."

    # 6ï¸âƒ£  Validar el entorno Lean con Python
    - name: ðŸ§ª Run Python validation script
      working-directory: formalization/lean
      run: |
        python3 validate_lean_env.py
        cat validation_report.json

    # 7ï¸âƒ£  Subir el informe JSON como artefacto
    - name: ðŸ“¤ Upload validation report
      uses: actions/upload-artifact@v4
      with:
        name: validation-report
        path: formalization/lean/validation_report.json

    # 8ï¸âƒ£  (Opcional) Publicar resumen en la interfaz de GitHub Actions
    - name: ðŸ§¾ Display summary
      if: always()
      run: |
        echo "### Riemannâ€“Adelic Lean Validation Summary ðŸ§ " >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        cat formalization/lean/validation_report.json | jq -r '"âœ… Status: \(.summary.status)\nðŸ§® Build Time: \(.build_time_sec)s\nâš ï¸ Warnings: \(.warnings)\nâŒ Errors: \(.errors)"' >> $GITHUB_STEP_SUMMARY
