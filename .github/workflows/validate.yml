name: Validate RH Proof

on:
  push:
    paths:
      - '**.py'
      - 'notebooks/**.ipynb'
      - 'zeros/**'
  workflow_dispatch:
    inputs:
      max_primes:
        description: 'Maximum primes to use'
        required: false
        default: '1000'
      max_zeros:
        description: 'Maximum zeros to use'  
        required: false
        default: '2000'
      test_functions:
        description: 'Test functions (space separated)'
        required: false
        default: 'f1 f2 f3'

jobs:
  run-validation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install jupyter

      - name: Ensure zeros data is available
        run: |
          python -c "from utils.fetch_odlyzko import ensure_zeros_available; ensure_zeros_available()"

      - name: Create output directories
        run: |
          mkdir -p data/ logs/

      - name: Run validation script
        run: |
          python validate_explicit_formula.py \
            --max_primes ${{ github.event.inputs.max_primes || '1000' }} \
            --max_zeros ${{ github.event.inputs.max_zeros || '2000' }} \
            --test_functions ${{ github.event.inputs.test_functions || 'f1 f2 f3' }} \
            --output_csv data/validation_results_$(date +%Y%m%d_%H%M%S).csv

      - name: Run pytest tests
        run: |
          python -m pytest tests/ -v --tb=short

      - name: Upload results artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: validation-results
          path: |
            data/
            logs/
          retention-days: 30

      - name: Save permanent results
        run: |
          # Keep the latest results for reference
          cp data/validation_results_*.csv data/latest_validation_results.csv || echo "No results to copy"