name: Enhanced RH Validation

on:
  push:
    paths:
      - '**.py'
      - 'notebooks/**.ipynb'
  workflow_dispatch:
    inputs:
      max_primes:
        description: 'Maximum number of primes'
        required: false
        default: '1000'
      max_zeros:
        description: 'Maximum number of zeros'
        required: false
        default: '2000'
      test_functions:
        description: 'Test functions (space-separated)'
        required: false
        default: 'truncated_gaussian'

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Setup data directories
        run: |
          mkdir -p data logs zeros

      - name: Ensure zeros data availability
        run: |
          python utils/fetch_odlyzko.py --target zeros/zeros_t1e8.txt

      - name: Run pytest before validation
        run: |
          python -m pytest tests/ -v

      - name: Run enhanced validation
        run: |
          MAX_PRIMES="${{ github.event.inputs.max_primes || '1000' }}"
          MAX_ZEROS="${{ github.event.inputs.max_zeros || '2000' }}"
          TEST_FUNCTIONS="${{ github.event.inputs.test_functions || 'truncated_gaussian' }}"
          
          python validate_explicit_formula.py \
            --P $MAX_PRIMES \
            --max_zeros $MAX_ZEROS \
            --test_functions $TEST_FUNCTIONS \
            --timeout 300 \
            --output_csv data/validation_results.csv

      - name: Collect and preserve artifacts
        uses: actions/upload-artifact@v4
        with:
          name: validation-results-${{ github.run_number }}
          path: |
            data/
            logs/
          retention-days: 30