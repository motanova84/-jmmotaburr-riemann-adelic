name: 📒 Ejecutar Notebook de Validación

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  run-notebook:
    runs-on: ubuntu-latest
    timeout-minutes: 45  # Increased from default to allow for 30min notebook + setup time

    steps:
      - name: 📥 Checkout repositorio
        uses: actions/checkout@v4

      - name: 🐍 Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: 📦 Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install jupyter nbconvert mpmath sympy numpy matplotlib scipy
          # Install requirements from repository
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: 📒 Ejecutar notebook
        run: |
          mkdir -p docs
          set +e
          # Execute with increased timeout (30 minutes) and log output
          jupyter nbconvert --to html --execute notebooks/validation.ipynb \
            --output-dir docs/ --output validation.html \
            --ExecutePreprocessor.timeout=1800 \
            --ExecutePreprocessor.kernel_name=python3
          EXIT_CODE=$?
          set -e
          if [ $EXIT_CODE -ne 0 ]; then
            echo "⚠️ Error al ejecutar el notebook"
            echo "📋 Checking for partial HTML output..."
            ls -la docs/ || true
            echo "🔍 First 100 lines of any HTML output:"
            head -100 docs/validation.html || echo "No HTML file generated"
            exit 1
          else
            echo "✅ Notebook executed successfully"
            ls -la docs/validation.html
          fi
        env:
          PYTHONUNBUFFERED: 1
          PRIME_COUNT: 50      # Even smaller for CI
          PRIME_POWERS: 3      # Reduced powers
          ZERO_COUNT: 50       # Minimal zeros
          INTEGRATION_T: 5     # Minimal integration range

      - name: 📤 Subir artefacto
        uses: actions/upload-artifact@v4
        with:
          name: validation-report
          path: docs/validation.html

      - name: 📊 Check execution summary
        if: success()
        run: |
          echo "✅ Notebook execution completed successfully"
          if [ -f docs/validation.html ]; then
            echo "📋 Extracting execution summary..."
            # Try to extract timing information from HTML
            grep -i "completed in\|execution time\|seconds" docs/validation.html || echo "No timing info found in HTML"
            echo "📊 File size: $(ls -lh docs/validation.html | awk '{print $5}')"
          fi